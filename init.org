# -*- buffer-read-only: t -*-
#+TITLE: Revolt's Killing of the Sea
#+PROPERTY: header-args :tangle init.el :comments link :eval never
#+STARTUP: content

* Emacs's Killing of the sea

** Emacs front Configuration

*** Auto Tangle
#+begin_src emacs-lisp
;;-*-emacs-lisp-*- -*-lexical-binding: t;-*-

;; Copyright (C) 2020 Mr.Revolt

;; Author: Mr.Revolt
;; Keywords: keybinding configuration

;;; Commentary:

;; Anything Keybinding configuration

;;; Code:

(defun revolt/make-init-el-and-starup ()
  "Tangle init.el and a startup file in init.org"
  (interactive "P")			;; places value of universal argument into: `current-prefix-arg'
  (when current-prefix-arg
    (message "You update emacs configure file successed...")
    (let* ((time (current-time))
           (_date (format-time-string "_%Y-%m-%d"))
           (.emacs "~/.emacs")
           (.emacs.el "~/.emacs.el"))
      (message "%S"  (list time _date .emacs .emacs.el))

      ;; Make init.el
      (org-babel-tangle)
      ;; (byte-compile-file "~/.emacs.d/init.el")
      (load-file "~/.emacs.d/init.el")

      ;; Make README.org
      (save-excursion
        (org-babel-goto-named-src-block "get-started") ;; See next subsubsection.
        (org-babel-execute-src-block))

      (message "Tangled, compiled, and loaded init.el; and made README.md … %.06f seconds"
               (float-time (time-since time))))))

(add-hook 'after-save-hook 'revolt/make-init-el-and-starup nil 'local-to-this-file-please)
#+end_src

*** The org block named make-startup

#+name: get-started
#+begin_src emacs-lisp
(message "hello world")			;test demo
#+end_src
*** Emacs statup message

#+begin_src emacs-lisp
;; Silence the usual message: Get more info using the about page via C-h C-a.
(setq inhibit-startup-message t)

(defun display-startup-echo-area-message ()
  "The message that is shown after ‘user-init-file’ is loaded."
  (message
   (concat "Welcome "      user-full-name
           "! Emacs "      emacs-version
           "; Org-mode "   (org-version)
           "; System "     (symbol-name system-type)
           "/"             (system-name)
           "; Time "       (emacs-init-time))))
;; Keep self motivated!
(setq frame-title-format '("" "%b - Living The Dream (•̀ᴗ•́)و"))
#+end_src

*** Custom setting
#+begin_src emacs-lisp
(setq custom-file "~/.emacs.d/custom.el")
(ignore-errors (load custom-file)) ;; It may not yet exist.
(setq enable-local-variables :safe)
#+end_src


** Package Manager

*** COMMENT Proxy setting

ref link: https://stackoverflow.com/questions/1595418/emacs-behind-http-proxy

#+begin_src emacs-lisp
(setq url-gateway-method 'socks)
(setq socks-server '("Default server" "127.0.0.1" 1088 5))
#+end_src
*** Package Source
#+begin_src emacs-lisp
;; Emacs package source
(require 'package)

;; slove contract melpa.gnu.org:443 question
;; https://www.reddit.com/r/emacs/comments/cdei4p/failed_to_download_gnu_archive_bad_request/etw48ux
;; https://stackoverflow.com/questions/29085937/package-refresh-contents-hangs-at-contacting-host-elpa-gnu-org80
;; Make all commands of the “package” module present.

(setq package-archives '(("org"       . "http://orgmode.org/elpa/")
                         ("gnu"       . "http://elpa.gnu.org/packages/")
                         ("melpa"     . "http://melpa.org/packages/")))

;; (package-initialize)

;; (package-refresh-contents)

;; China Tuna Package Source
;;(setq package-archives '(("gnu"   . "http://mirrors.tuna.tsinghua.edu.cn/elpa/gnu/")
;;				 ("melpa" . "http://mirrors.tuna.tsinghua.edu.cn/elpa/melpa/")))

(let* ((no-ssl (and (memq system-type '(windows-nt ms-dos))
                    (not (gnutls-available-p))))
       (proto (if no-ssl "http" "https")))
  (when no-ssl (warn "\
                                 Your version of Emacs does not support SSL connections,
                                 which is unsafe because it allows man-in-the-middle attacks.
                                 There are two things you can do about this warning:
                                 1. Install an Emacs version that does support SSL and be safe.
                                 2. Remove this warning from your init file so you won't see it again."))
  (add-to-list 'package-archives (cons "melpa" (concat proto "://melpa.org/packages/")) t)
  ;; Comment/uncomment this line to enable MELPA Stable if desired.  See `package-archive-priorities`
  ;; and `package-pinned-packages`. Most users will not need or want to do this.
  ;;(add-to-list 'package-archives (cons "melpa-stable" (concat proto "://stable.melpa.org/packages/")) t)
  )
#+end_src

*** Maintain already installed package
#+begin_src emacs-lisp
;; Package list
(defvar revolt/package-list
  '(
    better-defaults
    smartparens
    pkg-info
    epl
    doom-themes
    doom-modeline
    js2-mode
    js2-refactor
    xref-js2
    mermaid-mode
    helm
    helm-projectile
    helm-ag
    helm-flyspell
    flycheck
    helm-flycheck
    ;;ob-mermaid
    f
    dash
    youdao-dictionary
    names
    chinese-word-at-point
    pos-tip
    yasnippet
    yasnippet-snippets
    aggressive-indent
    wolfram
    slime
    quelpa
    pdf-tools
    ox-hugo
    web-mode
    web-beautify
    svelte-mode
    emmet-mode
    org-bullets
    ob-http
    monokai-theme
    helm-circe
    evil
    evil-leader
    which-key
    general
    window-numbering
    stumpwm-mode
    neotree
    htmlize
    real-auto-save
    markdown-mode
    edit-indirect
    polymode
    mmm-mode
    poly-R
    poly-markdown
    ess
    python-mode
    org-download
    pdf-tools
    org-noter
    engine-mode
    pyim
    org-roam
    org-roam-server
    w3m
    command-log-mode
    posframe
    sdcv
    expand-region
    company
    company-web
    ob-go
    company-go
    tern
    bind-key
    golden-ratio
    ace-window
    lsp-mode
    yaml-mode
    company-lsp
    evil-terminal-cursor-changer
    exec-path-from-shell
    doom-themes
    google-translate
    undo-tree
    highlight-symbol
    vterm
    org-download
    rainbow-delimiters
    ))

(setq package-selected-packages revolt/package-list)

;; Check my installed package state

(require 'cl)
(defun revolt/packages-installed-p()
  (loop for pkg in revolt/package-list
        when (not (package-installed-p pkg))
        do (return nil)
        finally (return t)
        ))

;; Fetch the list of package available
;; (unless package-archive-contents
;;   (package-refresh-contents))

;; Refersh package database and install it when package not installed
;; (unless (revolt/packages-installed-p)
;;   (message "%s" "Searching you lost package......")
;;   (package-refresh-contents)
;;   (message "%s" "Refersh successed melpa library!")
;;   (dolist (pkg revolt/package-list)
;;     (when (not (package-installed-p pkg))
;;       (package-install pkg))))

;; List the packages you want & install the missing packages
(dolist (revolt/package revolt/package-list)
  (unless (package-installed-p revolt/package)
    (package-install revolt/package)))
;; (require 'better-defaults)
#+end_src

*** Use quelpa manage emacs package
#+begin_src emacs-lisp
;; use quelpa manage pacakge
(unless (package-installed-p 'quelpa)
  (with-temp-buffer
    (url-insert-file-contents "https://raw.githubusercontent.com/quelpa/quelpa/master/quelpa.el")
    (eval-buffer)
    (quelpa-self-upgrade)))
;; (quelpa '(org-download :repo "abo-abo/org-download" :fetcher github))
#+end_src


** Basic customize and face setting


*** GUI configure
#+begin_src emacs-lisp
;; 关闭工具栏，Tool-Bar-Mode 即为一个 Minor Mode
(tool-bar-mode -1)
(menu-bar-mode -1)

;; 关闭文件滑动控件
(scroll-bar-mode -1)

;; 设置EMACS ORG MODE 下的文字间距
;; 显示行号
;; (global-linum-mode 1)

(setq-default line-spacing 0.4)

;; Set TAB key default indentation
;; disable default tab width
;; (setq-default tab-width 2)

;; 关闭备份文件
(setq make-backup-files nil)

;; 关闭启动帮助画面
(setq inhibit-splash-screen t
      initial-scratch-message "Welcome Elisp killing of the Sea! \n\n"
      ;; initial-major-mode 'org-mode
      )

;; 开启全局 Company 补全
;; (global-company-mode 1)

;; different state cursor form
(setq-default cursor-type 'bar)

;; simple request
(fset 'yes-or-no-p 'y-or-n-p)

;; show time in mode line
(setq display-time-24hr-format t)
(setq display-time-day-and-date t)
(display-time)

;; highlight selected area
(transient-mark-mode t)

;; 显示匹配的括号
(show-paren-mode t)

;; disable create bak file
(setq-default make-backup-files nil)

;; 括号自动补全
(electric-pair-mode 1)

;; auto fill mode
(add-hook 'org-mode-hook 'turn-on-auto-fill)

;; UTF-8 as default encoding
(set-language-environment "UTF-8")
(set-default-coding-systems 'utf-8-unix)

;; hacks to reduce the startup time.
(setq gc-cons-threshold (expt 2 24))
(setq load-prefer-newer t)

;; personal information
;; (setq user-full-name "revolt")

#+end_src

*** Font
#+begin_src emacs-lisp
;; (text-scale-increase 2)
;; (text-scale-decrease 2)
;; (text-scale-adjust 0)

;; (add-to-list 'default-frame-alist '(font . "Iosevka SS02 10"))

;; use 'describe-char' find current font used
;; not luck,is error.

;; set default font in initial window and for any new window
(cond
 ((string-equal system-type "gnu/linux")
  (when (member "Iosevka SS02" (font-family-list))
    (add-to-list 'initial-frame-alist '(font . "Iosevka fixed SS02-14"))
    (add-to-list 'default-frame-alist '(font . "Iosevka fixed SS14-14")))))

;; set font all windows. don't keep window size fixed
;; (set-frame-font "Iosevka Fixed SS14" nil t)
;; you must set the `pixelsize` the font will show beautiful!
;; (set-frame-font "Fira Code-12:style=Medium,Regular:antialias=True:pixelsize=14" nil t)
(set-frame-font "Roboto Mono-10:style=Regular,Medium,Bold,Italic,Thin:antialias=True:pixelsize=12" nil t)


;; Chinese Font -- 中文字体的话，必须设置为 14px，才能使Org Mode里面的Table对齐。很是Fuck。

;; ref link: https://emacs-china.org/t/org-mode/440/52
;; https://emacs-china.org/t/org-mode-9-3/11217/12

;; slove tty font does not exit problem: https://lists.gnu.org/archive/html/emacs-devel/2006-12/msg00285.html

(if (display-graphic-p)
    (dolist (charset '(kana han symbol cjk-misc bopomofo))
      (set-fontset-font (frame-parameter nil 'font)
                        ;; WenQuanYi Zen Hei
                        ;;charset (font-spec :family "WenQuanYi Zen Hei Mono Light"
                        charset (font-spec :family "HYQiHeiX1\-45W"
                                           ;; charset (font-spec :family "TsangerJinKai03\-6763 W03"
                                           :pixels 16
                                           :size 13)))) ;理解万岁

(require 'org-faces)
(set-face-attribute 'org-table nil :family "HYQiHeiX1\-45W")

(setq org-hide-emphasis-markers t)
(font-lock-add-keywords 'org-mode
                        '(("^ *\\([-]\\) "
                           (0 (prog1 () (compose-region (match-beginning 1) (match-end 1) "•"))))))
#+end_src

*** theme
#+begin_src emacs-lisp
(load-theme 'doom-dracula t)

;; set transparency
(set-frame-parameter (selected-frame) 'alpha '(90 90))
(add-to-list 'default-frame-alist '(alpha 90 90))

;; (load-theme 'vivid t)
;; Nice,the answer in here
;; https://stackoverflow.com/questions/18684579/how-do-i-change-the-highlight-color-for-selected-text-with-emacs-deftheme
(set-face-attribute 'region nil :background "#FBD7CF")
(provide 'init-global-themes)
#+end_src

*** symbol face
#+begin_src emacs-lisp
;; 全局启动符号美化
(global-prettify-symbols-mode)
;; (defconst lisp--prettify-symbols-alist
;;   '(("lambda"  . ?λ)))
#+end_src
*** init-key-binding
#+begin_src emacs-lisp
;; recentf open file
(defun open-recentf-files()
  (interactive)
  (recentf-mode)
  (recentf-open-files))

;; (global-set-key (kbd "C-x C-r") 'open-recentf-files)
(global-set-key (kbd "C-x C-r") 'helm-recentf)

;; store org link
(global-set-key (kbd "C-c l") 'org-store-link)

(with-eval-after-load
    ;; which key mode
    (require 'which-key)
  ;; (which-key-setup-side-window-bottom)

  (which-key-setup-side-window-bottom)
  ;; which-key 延迟太高,需要降低,激活键是 `C-x`

  ;; Set the time delay (in seconds) for the which-key popup to appear. A value of
  ;; zero might cause issues so a non-zero value is recommended.
  (setq which-key-idle-delay 1)
  ;; whick-key的触发，与C-h有关，所以现在变为 `C-x C-h'
  ;; (setq which-key-show-early-on-C-h t)
  (setq which-key-idle-secondary-delay 0.01)

  ;; Set the maximum length (in characters) for key descriptions (commands or
  ;; prefixes). Descriptions that are longer are truncated and have ".." added.
  (setq which-key-max-description-length 27)

  ;; Use additional padding between columns of keys. This variable specifies the
  ;; number of spaces to add to the left of each column.
  (setq which-key-add-column-padding 0)
  (which-key-mode)
  )
#+end_src

*** firefox browser setting
#+begin_src emacs-lisp
;; (setq browse-url-browser-function 'browse-url-firefox)

;; ;; 给w3m 浏览器设置代理

;; (setq w3m-command "~/.emacs.d/lisp/customize/w3m.sh")


;; ;; use w3m as default browser
;; (setq browse-url-browser-function 'w3m-browse-url)
;; (setq w3m-view-this-url-new-session-in-background t)


;; (add-to-list 'load-path "/usr/bin/w3m")
;; (require 'w3m-load)

;; (autoload 'w3m-browse-url "w3m" "Ask a WWW browser to show a URL." t)

;; ;; set w3m homepage
;; (setq w3m-home-page "http://www.google.com")

;; ;; defalut show image
;; (setq w3m-default-display-inline-images t)
;; (setq w3m-toggle-inline-images-permanently t)

;; ;; use cookie
;; (setq w3m-use-cookies t)

;; ;; keyboard short-cut
;; (global-set-key "\C-xm" 'browse-url-at-point)

;; ;; show icons
;; (setq w3m-show-graphic-icons-in-header-line t)
;; (setq w3m-show-graphic-icons-in-mode-line t)
#+end_src

*** svg label

#+begin_src emacs-lisp
(require 's)
(require 'svg)

(defface tag-face
  '((t :foreground "white" :background "orange" :box "orange"
       :family "Roboto Mono" :weight medium :height 160))
  "Default face for tag" :group 'tag)

(defun tag (text &optional face inner-padding outer-padding radius)
  (let* ((face       (or face 'tag-face))
         (foreground (face-attribute face :foreground))
         (background (face-attribute face :background))
         (border     (face-attribute face :box))
         (family     (face-attribute face :family))
         (weight     (face-attribute face :weight))
         (size       (/ (face-attribute face :height) 9))

         (tag-char-width  (window-font-width nil face))
         (tag-char-height (window-font-height nil face))
         (txt-char-width  (window-font-width))
         (txt-char-height (window-font-height))
         (inner-padding   (or inner-padding 0))
         (outer-padding   (or outer-padding 0))

         (text (s-trim text))
         (tag-width (* (+ (length text) inner-padding) txt-char-width))
         (tag-height (* txt-char-height  1.4))

         (svg-width (+ tag-width (* outer-padding txt-char-width)))
         (svg-height tag-height)

         (tag-x (/ (- svg-width tag-width) 1))
         (text-x (+ tag-x (/ (- tag-width (* (length text) tag-char-width)) 0.5)))
         (text-y (- tag-char-height (- txt-char-height tag-char-height)))

         (radius  (or radius 3))
         (svg (svg-create svg-width svg-height)))

    (svg-rectangle svg tag-x 0 tag-width tag-height
                   :fill        border
                   :rx          radius)
    (svg-rectangle svg (+ tag-x 1) 1 (- tag-width 2) (- tag-height 2)
                   :fill        background
                   :rx          (- radius 1))
    (svg-text      svg text
                   :font-family family
                   :font-weight weight
                   :font-size   size
                   :fill        foreground
                   :x           text-x
                   :y           text-y)
    (svg-image svg :ascent 'center)))

(defface tag-note-face
  '((t :foreground "black" :background "yellow" :box "black"
       :family "Roboto Mono" :weight medium :height 120))
  "Face for note tag" :group 'tag)

(defface tag-key-face
  '((t :foreground "#333333" :background "#f0f0f0" :box "#999999"
       :family "Roboto Mono" :weight medium :height 120))
  "Face for key tag" :group 'tag)

(setq tag-todo (tag "TODO" nil 1 1 3))
(setq tag-note (tag "NOTE" 'tag-note-face 1 1 3))


;; A tag function using SVG to display a rounded box with outer and inner
;; padding and a controllable box radius. The resulting SVG is perfectly
;; aligned with regular text such that a =TAG= can be inserted and edited
;; anywhere in the text thanks to font-lock and the display property.

(add-to-list 'font-lock-extra-managed-props 'display)
(font-lock-add-keywords nil
                        '(("\\(\:TODO\:\\)" 1 `(face nil display ,tag-todo))
                          ("\\(\:NOTE\:\\)" 1 `(face nil display ,tag-note))
                          ("\\(=[0-9a-zA-Z- ]+?=\\)" 1
                           `(face nil display
                                  ,(tag (substring (match-string 0) 1 -1) 'tag-key-face 1 1 3)))))

;; |:TODO:| Make a minor mode
;; |:NOTE:| Don't know how to do it, help needed…
;; | :______: | Perfect alignment with regular text
;; :TODO:
;;  Save ................. =C-x=+=C-s=  Help ............... =C-h=
;;  Save as .............. =C-x=+=C-w=  Cancel ............. =C-g=
;;  Open a new file ...... =C-x=+=C-f=  Undo ............... =C-z=
;;  Open recent .......... =C-x=+=C-r=  Close buffer ....... =C-x=+=k=
;;  Browse directory ......=C-x=+=d=    Quit ............... =C-x=+=C-c=
#+end_src


** Org mode

*** ob-markdown
#+begin_src emacs-lisp
;; ref: https://github.com/tnoda/ob-markdown
(require 'ob)
(require 'ob-eval)
(require 'markdown-mode)
;; possibly require modes required for your language

;; optionally define a file extension for this language
(add-to-list 'org-babel-tangle-lang-exts '("markdown" . "text"))

;; optionally declare default header arguments for this language
(defvar org-babel-default-header-args:markdown '())

;; This function expands the body of a source code block by doing
;; things like prepending argument definitions to the body, it should
;; be called by the `org-babel-execute:markdown' function below.
(defun org-babel-expand-body:markdown (body params &optional processed-params)
  "Expand BODY according to PARAMS, return the expanded body."
  body)

(defun org-babel-execute:markdown (body params)
  "Execute a block of Markdown code with org-babel.  This function is
    called by `org-babel-execute-src-block'."
  (message "executing Markdown source code block")
  (org-babel-eval markdown-command (org-babel-expand-body:markdown body params)))

;; This function should be used to assign any variables in params in
;; the context of the session environment.
(defun org-babel-prep-session:markdown (session params)
  "Return an error if the :session header argument is Set.
    Markdown does not support sessions."
  (error "Markdown sessions are nonsensical."))

(provide 'ob-markdown)
#+end_src
*** org babel
#+begin_src emacs-lisp
;; Active Org mode babel support language
;; ref link: http://archive.3zso.com/archives/orgmode-babel.html
(org-babel-do-load-languages
 'org-babel-load-languages
 '((emacs-lisp . t)
   (shell . t)
   (scheme . t)
   (markdown . t)
   (js . t)
   (R . t)
   (dot . t)
   (css . t)
   (http . t)
   (latex .t)
   (org . t)
   (perl . t)
   (ruby . t)
   (go . t)
   (python . t)))

;; (defun my-org-confirm-babel-evaluate (lang body)
;;   (not (string= lang "emacs-lisp")))  ;don't ask for ditaa
;; (setq org-confirm-babel-evaluate #'my-org-confirm-babel-evaluate)

;; let Org-mode Babel src code block auto set `web-mode-engine' for rhtml.
(defadvice org-edit-special (before org-edit-src-code activate)
  (let ((lang (nth 0 (org-babel-get-src-block-info))))
    (if (string= lang "rhtml")
        (web-mode-set-engine "erb"))
    ))
#+end_src

*** Org bullet
#+begin_src emacs-lisp
(require 'org-bullets)
(add-hook 'org-mode-hook (lambda () (org-bullets-mode 1)))
(setq org-bullets-bullet-list '("🦄" "♈" "🕊" "🐱" "🎉" "♥"))
#+end_src

*** COMMENT Org download
#+begin_src emacs-lisp
(require 'org-download)
(setq-default org-download-image-dir "~/.emacs.d/.picture/org/")
;; Drag-and-drop to `dired`
(add-hook 'dired-mode-hook 'org-download-enable)
#+end_src

*** COMMENT latex
#+begin_src emacs-lisp
;; set latex environment path
(setenv "PATH"
        (concat
         "/usr/local/sbin" ":"
         "/usr/local/bin" ":"
         "/usr/bin" ":"
         "/usr/bin/site_perl" ":"
         "/usr/bin/vendor_perl" ":"
         "/usr/bin/core_perl" ":"
         "/usr/local/texlive/2019/bin/x86_64-linux" ":"))

;;使用XeLaTeX编译
(require 'ox-latex)
(setq org-export-latex-listings t)
(setq org-latex-pdf-process
      '("xelatex -interaction nonstopmode %b"
        "xelatex -interaction nonstopmode %b"))
#+end_src
*** Org Capture && Org Agenda
#+begin_src emacs-lisp
(global-set-key (kbd "C-c a") 'org-agenda)
#+end_src
*** Org Customize
**** Image size setting
#+begin_src emacs-lisp
;; (setq org-image-actual-width nil)

;; org redisplay inline images
(add-hook 'org-babel-after-execute-hook 'org-redisplay-inline-images)
#+end_src
**** customize setting org header properties
#+begin_src emacs-lisp
;; (require 'org-id)

;; (save-excursion
;;       (goto-char (point-max))
;;       (while (outline-previous-heading)
;;         (org-id-get-create)))

;; add tangle-dir property

(defun org-in-tangle-dir (sub-path)
  "Expand the SUB-PATH into the directory given by the tangle-dir
       property if that property exists, else use the
       `default-directory'."
  (expand-file-name sub-path
                    (or
                     (org-entry-get (point) "tangle-dir" 'inherit)
                     (default-directory))))
#+end_src
**** Org highlight code && available indent
#+begin_src emacs-lisp
;; syntax highlight code

;; 解决org mode中代码高亮 + 代码导出正确缩进
;; https://github.com/kaushalmodi/ox-hugo/issues/314
;; https://emacs.stackexchange.com/questions/18877/how-to-indent-without-the-two-extra-spaces-at-the-beginning-of-code-blocks-in-or/18892#18892

(setq org-confirm-babel-evaluate nil
      org-src-fontify-natively t
      org-src-window-setup 'current-window
      org-src-strip-leading-and-trailing-blank-lines t
      org-src-preserve-indentation t
      org-src-tab-acts-natively t)

(setq org-startup-indented t)

;; default hidden org block
;; (setq org-hide-block-startup t)

;; import org font
;; (require 'init-org-font "./org-font/init-org-font")

;; use org auto complete extension: org-ac
;; (require 'org-ac)
;; (org-ac/config-default)
#+end_src
**** Org default dir
#+begin_src emacs-lisp
(setq org-directory "~/.emacs.d/.org/")
#+end_src
**** for every assign a id
#+begin_src emacs-lisp
(setq org-id-link-to-org-use-id 'create-if-interactive)
#+end_src

测试 org ID 访问另外 Org mode file 的 entry

[[id:8fc4a985-1080-4787-a608-173987cfd820][test_capture]]

*** Org Notes
在 Org mode 中高效记下笔记的方法：

1. [[*为主 Org file 设置快捷键][为主 Org file 设置快捷键]]
2. [[*使用 Org refile 归档或者跳转到标题][使用 Org refile 归档或者跳转到标题]]
3. [[*Use org-capture to write notes quickly][Use org-capture to write notes quickly]]
4. [[*定义更加便利的Org-capture模板][定义更加便利的Org-capture模板]]
5. [[*额外的需求][额外的需求]]

**** 为主 Org file 设置快捷键

所有键的设置都将会集成在 =general= 这个包的配置当中。

1. 将快捷键设置为 =SPC f e o= 即可。
2. 或者使用寄存器， =C-x r j= ,指定寄存器的名字，来实现快速跳转，在这里，
   我们设置为 =C-x r j o=
3. 使用 `helm-occure` 快速查找东西。

**** DONE 使用 Org refile 归档或者跳转到标题

使用 =org-refile= 来移动当前的 subtree 到指定的 heading,或者跳转到不需要
移动任何文本的 heading.这将让你快速进入 project, 或者在 Org mode 中的
任何地方。

默认情况下， =org-refile= 会显示当前文件的顶级headings.但这远远不够，我
们想要的效果是从Agenda file中显示所有的heading.一般设置7级就可以了。当
然确保你的 Agenda file list 里面有东西。 使用 =C-c [= 调用
=org-agenda-file-to-front= 函数将当前Org file添加到 Agenda file里。

#+begin_src emacs-lisp
(setq org-refile-targets '((org-agenda-files . (:maxlevel . 7))))
#+end_src

一旦设置好 =org-refile-targets= ,你的 Agenda files, 使用 =helm-occur=.就可
以练习使用 =C-c C-w= ~org-refile~ 了。 =org-refile= 可以做不同的使用，取决于
你如何调用它。

- 默认情况下，它移动当前的subtree到指定的位置。
- 如果你带前缀 =C-u= 比如， =C-u C-c C-w= 调用，它将会跳转指定位置，而不是
  移动当前的subtree.
- 如果你使用 =C-u C-u C-c C-w=, 它将会跳转到归档之前的位置。

首先练习跳转位置，跳转到未分类的manual,使用不带前缀参数的 =org-refile=
将其移动到正确的位置，实现文档的分类。

=org-refile= 给你提供来一种快速跳转heading的方法。 你要更加喜欢
=helm-occur= 也行。但在你想做笔记之前，还是要想办法回到你之前正在做的事
情上。在你熟悉来如何将笔记重新归档到正确的位置之后，继续学习如何使用
=org-capture= 从任何地方快速的记笔记。

**** Use org-capture to write notes quickly

=org-capture= 通过弹出窗口或者通过提示来引导你快速记下笔记。当你记下笔记
后，它会让你回到开始之前正在专注的东西。不过，要想利用这个优点，你必须
自定义设置 =org-capture=.

Org Mode manual推荐你给定 =org-capture= 全局快捷键，比如 =C-c c=.然后再设
置下默认的笔记保存目录就可以，搞好了，利用 =org-refile= 重新分档即可。需
要确保这个文件存在并再 Org mode 中自动打开。

#+begin_src emacs-lisp
(global-set-key (kbd "C-c c") 'org-capture)
(setq org-default-notes-file "~/.emacs.d/.agenda/task_index.org")
#+end_src

如果键入 =C-c c= , =org-capture= 将会展示提示， 按下 =t= 会创建简单的任务模
板，按下 =C= 会展示 =org-capture-template= 的自定义接口。

可能你需要插入计划的开始时间 =C-c C-s= 与预计结束时间 =C-c C-d=,以此来作为
计算效率的基准。

接下来就是练习 =C-c c= ~org-capture~ 快速记下一些任务或者笔记，接下来回到笔
记文件并使用 =C-c C-w= ~org-refile~ 来将笔记重新归档就可以了。

一旦你掌握了使用 =org-capture= 来记下笔记，只需要每周一次将他们归档就可
以了。

**** 定义更加便利的Org-capture模板

如果你发现你自己经常捕获不同种类的笔记，或者你想以另外一种格式来捕获东
西（可以是 table entry, 或者 list），同时又想自定义
=org-capture-template= 来插入时间。在开始之前，你需要了解下
=org-capture-templates= 的接口。不要直接上来就写代码，简单读些文档，自己
去做试验测试。

***** Capture templates

对于不同类型，不同目标位置的捕获项目，你可以使用模板。最容易的方法就是
通过自定义接口来创建一些模板。

假设你想使用模板创建普通的 TODO 条目，并且你想将這些条目放置到文件
=~/.emacs.d/.org/gtd.org= 中的 heading =Tasks= 下面。

另外你得有个名为 =journal.org= 的日志文件，需要包含时间戳，所以看起来像
下面这样：

另外需要快速捕获网页的内容，进行归档，加速转换。
[[*直接使用工具包 org-capture-capture-html + 配置模板（org-capture-template）][直接使用工具包 org-capture-capture-html + 配置模板（org-capture-template）]]

If you then press t from the capture menu, Org will prepare the
template for you like this:

During expansion of the template, ‘%a’ has been replaced by a link to
the location from where you called the capture command. This can be
extremely useful for deriving tasks from emails, for example. You fill
in the task definition, press C-c C-c and Org returns you to the same
place where you started the capture process.

To define special keys to capture to a particular template without
going through the interactive template selection, you can create your
key binding like this:

**** 额外的需求

在手机端用 =Evernote= 代替，或者 =Simplenote=.直接在网页端同步到 Emacs 上
即可。

*** Org protocol

Org-protocol 拦截来自 Emacsclient 的调用，从而在没有外部依赖的情况下触
发自定义操作。外部应用程序或操作系统只需要配置一个协议，就可以触发任意
数量的定制操作。只需用变量 =org-protocol-protocol-alist= 注册您的自定义
子协议和处理程序。

基本思路大致如下，首先需要在守护程序模式下运行 Emacs,因为需要使用
=Emacsclient= 来处理Org protocol请求。接着，需要在桌面上设置 Org
protocol 处理程序，最后需要配置一些 Org Capture 模板来处理从浏览器发送
的数据。

**** org protocol 的组成

Org-protocol 基于 =org-annotation-helper= 和 =org-browser-url=.

="org-protocol:/sub-protocol:/"= 通过自定义变量
=org-protocol-protocol-alist= 触发和 ~sub-protocl~ 关联的行为。

它主要提供四个预定义的处理程序。

- org-protocol-store-link ::
  通过 sub-protocol ="store-link"= 触发。存储 Org-link 和 给 kill-ring
  推送 URL.

- org-protocol-capture :: 填充从其他地方收集信息捕获的buffer. 此处理器
  通过 ~"capture"~ sub-protocol 和 使用 函数 =org-capture= 来触发。

- org-protocol-remember ::
  填充从其他地方收集信息的记忆 buffer.此处理器通过 ~"remember"~
  sub-protocol 触发，并仍可向后兼容。此处理器使用 =org-remember=.使用当
  前的 ~org-protocol-capture~.

- org-protocol-open-source ::
  "open-source". 映射 URLs 到本地文件名。 使用它用来打开 Emacs 中已经
  发布的内容的源代码，以便进行编辑。

Org-protocol 帮助创建自定义处理程序，即所谓的 =org-protocol-projects=.

**** 配置 =org-protocol= 处理程序

#+begin_src shell :tangle "~/.local/share/applications/org-protocol-handler.desktop" :comments no
[Desktop Entry]
Version=1.0
Type=Application
Exec=/usr/bin/emacsclient %u
Icon=/usr/share/icons/hicolor/scalable/apps/emacs.svg
StartupNotify=true
Terminal=false
Categories=Utility;X-XFCE;X-Xfce-Toplevel;
MimeType=x-scheme-handler/org-protocol
Name=Org Protocol Handler
Comment=Invoke emacsclient with org-protocol
#+end_src

#+begin_src shell :tangle "~/.local/share/applications/mimeapps.list" :comments no
x-scheme-handler/org-protocol=exo-org-protocol.desktop
#+end_src

然后更新桌面数据库： 

#+begin_src shell :tangle no :eval never
update-desktop-database  ~/.local/share/applications/
#+end_src

**** Installation

载入 =org-protocol.el=.[[*Configure Emacs][Configure Emacs]].

**** COMMENT 浏览器和系统设置
***** 基于 Linux KDE 桌面的设置。

#+begin_src shell :tangle "/sudo::/home/mrrevolt/.kde4/share/services/org.protocol" :comments no
# -*- conf -*-
[Protocol]
protocol=org-protocol
exec=/usr/bin/emacsclient '%u'
input=none
output=none
helper=true
listing=
reading=false
writing=false
makedir=false
deleting=false
Icon=emacs
Description=A protocol for org-mode
#+end_src

***** 在 firefox 浏览器上注册协议

协议是一种通过连接发送、接收和处理信息的方法。从浏览器中查看的常见协议
包括 http 、https、 ftp 和 mailto。为了查看通过特定协议发送的信息，必
须对其进行注册。如果你在地址栏输入一个未知协议(foo)的URL，你会收到这样
的消息，Firefox不知道如何打开这个地址，因为这个协议(foo)与任何程序都没
有关联，或者，在Mozilla Suite/SeaMonkey 中，foo不是一个注册协议。

一旦注册，协议就可以由您指定的程序处理，比如您的浏览器或第三方查看器。
这意味着一个超链接(例如foo://fred)可以使用协议foo的处理程序来打开名为
fred 的文件。

****** 在Linux没有安装Gnome库的基础上的配置

可以直接在浏览器上建立书签来捕获内容。

#+begin_src js :eval never :comments no :tangle no
javascript: location.href = 'org-protocol://capture-html?template=w&url=' + encodeURIComponent(location.href) + '&title=' + encodeURIComponent(document.title || "[untitled page]") + '&body=' + encodeURIComponent(function() {
  var html = "";
  if (typeof document.getSelection != "undefined") {
    var sel = document.getSelection();
    if (sel.rangeCount) {
      var container = document.createElement("div");
      for (var i = 0, len = sel.rangeCount; i < len; ++i) {
        container.appendChild(sel.getRangeAt(i).cloneContents());
      }
      html = container.innerHTML;
    }
  } else if (typeof document.selection != "undefined") {
    if (document.selection.type == "Text") {
      html = document.selection.createRange().htmlText;
    }
  }
  var relToAbs = function(href) {
    var a = document.createElement("a");
    a.href = href;
    var abs = a.protocol + "//" + a.host + a.pathname + a.search + a.hash;
    a.remove();
    return abs;
  };
  var elementTypes = [
    ['a', 'href'],
    ['img', 'src']
  ];
  var div = document.createElement('div');
  div.innerHTML = html;
  elementTypes.map(function(elementType) {
    var elements = div.getElementsByTagName(elementType[0]);
    for (var i = 0; i < elements.length; i++) {
      elements[i].setAttribute(elementType[1], relToAbs(elements[i].getAttribute(elementType[1])));
    }
  });
  return div.innerHTML;
}());
#+end_src

无缩进的写法

#+begin_src js :tangle no
javascript:location.href = 'org-protocol://capture-html?template=w&url=' + encodeURIComponent(location.href) + '&title=' + encodeURIComponent(document.title || "[untitled page]") + '&body=' + encodeURIComponent(function () {var html = ""; if (typeof document.getSelection != "undefined") {var sel = document.getSelection(); if (sel.rangeCount) {var container = document.createElement("div"); for (var i = 0, len = sel.rangeCount; i < len; ++i) {container.appendChild(sel.getRangeAt(i).cloneContents());} html = container.innerHTML;}} else if (typeof document.selection != "undefined") {if (document.selection.type == "Text") {html = document.selection.createRange().htmlText;}} var relToAbs = function (href) {var a = document.createElement("a"); a.href = href; var abs = a.protocol + "//" + a.host + a.pathname + a.search + a.hash; a.remove(); return abs;}; var elementTypes = [['a', 'href'], ['img', 'src']]; var div = document.createElement('div'); div.innerHTML = html; elementTypes.map(function(elementType) {var elements = div.getElementsByTagName(elementType[0]); for (var i = 0; i < elements.length; i++) {elements[i].setAttribute(elementType[1], relToAbs(elements[i].getAttribute(elementType[1])));}}); return div.innerHTML;}());
#+end_src

*** Real Org protocol

Org Mode 官网的有些东西有些很难进行试验。下面应用下真实世界的例子。

**** Add Protocol handler

创建下面的协议，注意每行的键必须大写，否则无效。

***** COMMENT 方法一，无效,有空再搞
#+begin_src shell :tangle "~/.local/share/applications/org-protocol.desktop" :comments no
[Desktop Entry]
Name=org-protocol
Exec=emacsclient %u
Type=Application
Terminal=false
Categories=System;
MimeType=x-scheme-handler/org-protocol;
#+end_src

然后运行 =kbuildsycoca5= 更新 =~/.local/share/applications/mimeinfo.cache=
文件。

***** 方法二，生效
[[*配置 =org-protocol= 处理程序][配置 =org-protocol= 处理程序]], [[https://vurt.co.uk/post/org_capture_configuration/][参考依据]].

**** Configure Emacs

载入 =org-protocol.el=.

#+begin_src emacs-lisp
(server-start)
;; (add-to-list 'load-path "~/.emacs.d/.org/protocol/")
;; Emacs 内置，不需要外部引入
(require 'org-protocol)
#+end_src

**** 配置 firefox

在某些版本的Firefox中，可能需要添加此设置。如果Firefox不知道如何处理
org协议链接，您可以跳过这一步，然后返回到它。

搜索框输入 =about:config= and create a new boolean value named
~network.protocol-handler.expose.org-protocol~ and set it to true.

**** 直接使用工具包 org-capture-capture-html + 配置模板（org-capture-template）

Ref link : https://github.com/alphapapa/org-protocol-capture-html

#+begin_src emacs-lisp :comments no
(add-to-list 'load-path "~/.emacs.d/.utils/org-protocol-capture-html/")
(require 'org-protocol-capture-html)

;; ref link: https://www.zmonster.me/2018/02/28/org-mode-capture.html
(defun org-capture-template-goto-link ()
  (org-capture-put :target (list 'file+headline
                                 (nth 1 (org-capture-get :target))
                                 (org-capture-get :annotation)))
  (org-capture-put-target-region-and-position)
  (widen)
  (let ((hd (nth 2 (org-capture-get :target))))
    (goto-char (point-min))
    (if (re-search-forward
         (format org-complex-heading-regexp-format (regexp-quote hd)) nil t)
        (org-end-of-subtree)
      (goto-char (point-max))
      (or (bolp) (insert "\n"))
      (insert "* " hd "\n"))))

(setq org-capture-templates
      '(
        ;; 定义协议组,ref link: https://github.com/progfolio/doct
        ("p" "capture protocol group")
        ("pb" "Protocol Bookmarks" entry
         (file+headline "~/.emacs.d/.org/web.org" "Bookmarks")
         "* %U - %:annotation"
         :immediate-finish t
         :kill-buffer t
         :prepend t)
        ("pn" "Protocol"
         entry (file+headline "~/.emacs.d/.org/web.org" "New Notes")
         "* %:description :RESEARCH:\n#+BEGIN_QUOTE\n%i\n\n -- %:link %u\n #+END_QUOTE\n\n%?"
         :prepend t)
        ("ph" "Protocol Bookmarks" entry
         (file+headline "~/.emacs.d/.org/web.org" "Notes")
         "* %U - %:annotation %^g\n\n  %?"
         :empty-lines 1
         :kill-buffer t
         :prepend t
         )

        ;; 追加内容，依托于 org-capture firefox/chrome 插件，函数参考：
        ("pl" "Protocol Annotation" plain
         (file+function "~/.emacs.d/.org/web.org" org-capture-template-goto-link)
         "%U  %?\n\n  %:initial"
         :empty-lines 1
         :prepend t
         )

        ;; 结合Firefox上面的书签制作书签管理器,依靠 org-protocol-capture-html
        ("w" "Web site" entry
         (file+headline "~/.emacs.d/.org/web.org" "Bookmarks")
         "** %a :website:\n\n%U %?\n\n%:initial")

        ;; 定义普通任务
        ("t" "Todo"
         entry (file+headline "~/.emacs.d/.org/notes/gtd.org" "Tasks"))

        ;; 以时间为 heading,记录你当天做了啥事
        ("j" "Journal" entry (file+datetree "~/.emacs.d/.org/notes/journal.org")
         "* %?\nEntered on %U\n  %i\n  %a")

        
        ("L" "Protocol Link"
         entry (file+headline "~/.emacs.d/.org/web.org" "New Notes")
         "* %? [[%:link][%:description]] \nCaptured On: %u")
        ))
#+end_src

**** FAQ

***** getting org-protocol to work on Firefox Quantum — `No server buffers remain to edit` error

很大可能就是没安装 =pandoc=, 具体参见 [[https://stackoverflow.com/questions/47647948/getting-org-protocol-to-work-on-firefox-quantum-no-server-buffers-remain-to][here]].


** Packages Library Setting

*** Evil
#+begin_src emacs-lisp
(require 'evil)
(require 'evil-leader)

(global-evil-leader-mode)
(evil-mode 1)

;; define evil key binding
(define-key evil-ex-map "o" 'helm-occur)

(setq evil-insert-state-cursor '((bar . 3) "orange red")
      evil-normal-state-cursor '(box "purple"))

(defun open-my-init-file()
  "快速打开配置文件."
  (interactive)
  (find-file "~/.emacs.d/init.el")
  (eval-buffer)
  (find-file "~/.emacs.d/lisp/init-package.org")
  )

;; vim command cookbook: http://tnerual.eriogerg.free.fr/vimqrc.pdf

(defalias 'sc 'shell-command)
(defun gif-record()
  "在当前文件夹中生成GIF图."
  (interactive)
  (sc "~/.emacs.d/lisp/private/shell_tools/byzanz-record-region.sh 10 'screen'_$(date +'%Y.%m.%d-%H:%M:%S').gif")
  (message "GIF 图生成在当前的文件夹")
  )

(defun format-paragraph()
  "填充式格式化当前段落"
  (interactive)
  (mark-paragraph)
  (interactive)
  (fill-region)
  )

(defun quick-open-org-main-file()
  "Quick open Org main file for take notes"
  (interactive)
  (find-file "~/.emacs.d/.org/notes/organizer.org")
  )

(set-register ?o (cons 'file "~/.emacs.d/.org/notes/organizer.org"))

;; need install general.el package from melpa
(general-define-key
 :keymaps '(normal insert emacs)
 :prefix "SPC"
 :non-normal-prefix "M-SPC"
 "b" '(:ignore t :which-key "buffers")
 "f" '(:ignore t :which-key "files")
 "n" '(:ignore t :which-key "neotree")
 "g" '(:ignore t :which-key "script")
 "c" '(:ignore t :which-key "company")
 "u" '(:ignore t :which-key "unix")
 "m" '(:ignore t :which-key "mark")
 "h" '(:ignore t :which-key "helm-key")
 "h o" 'helm-occur
 "c i" 'toggle-company-english-helper
 "n t" 'neotree-toggle
 "n d" 'neotree-dir
 "f e d" 'open-my-init-file
 "f e o" 'quick-open-org-main-file
 "b k" 'buf-move-up
 "b j" 'buf-move-down
 "b h" 'buf-move-left
 "b l" 'buf-move-right
 "u s" 'unix-sync
 "g b" 'shell-command-on-buffer
 "g r" 'gif-record
 "m m" 'format-paragraph
 "b d" 'kill-buffer-and-window)

;; enable super key.
(general-define-key
 :prefix "s-c"
 "a" 'org-agenda
 "c" 'org-capture
 )

(general-define-key
 :prefix "H-<return>"
 :keymaps '(yas-minor-mode-map normal insert emacs)
 "i" 'sdcv-search-input+
 "RET" 'insert-translated-name-insert
 "SPC" 'yas-maybe-expand
 "y" #'yas-expand
 )

;;(define-key yas-minor-mode-map (kbd "C-c y") #'yas-expand)
;; (global-set-key (kbd "H-<return>") 'insert-translated-name-insert) ; H is for hyper(global-set-key (kbd "s-b") 'ba)


;; define ace window keybinding
;; cause me use evil-mode,so don't need ace jump.

(general-define-key
 :keymaps '(normal)
 :prefix "C-w"
 "C-w" 'ace-window
 "s" 'ace-swap-window
 "d" 'ace-delete-window
 "o" 'ace-delete-other-windows
 "v" (lambda ()
       (interactive)
       (split-window-right)
       (windmove-right))
 "x" (lambda ()
       (interactive)
       (split-window-below)
       (windmove-down))
 "h" 'windmove-left
 "j" 'windmove-down
 "k" 'windmove-up
 "l" 'windmove-right
 )
#+end_src
*** Evil terminal cursor setting
#+begin_src emacs-lisp
(unless (display-graphic-p)
  (require 'evil-terminal-cursor-changer)
  (evil-terminal-cursor-changer-activate) ; or (etcc-on)
  )
(setq evil-motion-state-cursor 'box)  ; █
(setq evil-visual-state-cursor 'box)  ; █
(setq evil-normal-state-cursor 'box)  ; █
(setq evil-insert-state-cursor 'bar)  ; ⎸
(setq evil-emacs-state-cursor  'hbar) ; _
#+end_src
*** Helm
#+begin_src emacs-lisp
(with-eval-after-load
    (require 'helm)
  (helm-mode 1)
  (require 'helm-config)

  (global-set-key (kbd "M-x") #'helm-M-x)
  (global-set-key (kbd "s-f") #'helm-projectile-ag)
  (global-set-key (kbd "s-t") #'helm-projectile-find-file-dwim)

  (setq helm-M-x-fuzzy-match t) ;; optional fuzzy matching for helm-M-x

  (global-set-key (kbd "M-y") 'helm-show-kill-ring)

  (global-set-key (kbd "C-x b") 'helm-mini)

  (setq helm-buffers-fuzzy-matching t
        helm-recentf-fuzzy-match    t)

  (global-set-key (kbd "C-x C-f") 'helm-find-files)

  (setq helm-semantic-fuzzy-match t
        helm-imenu-fuzzy-match    t)

  ;; if you want from emacs history command jump to eamcs commands,please use `C-o`
  ;; ref link: https://emacs.stackexchange.com/questions/18173/how-to-jump-from-emacs-command-history-to-emacs-commands-in-helm

  ;; The default "C-x c" is quite close to "C-x C-c", which quits Emacs.
  ;; Changed to "C-c h". Note: We must set "C-c h" globally, because we
  ;; cannot change `helm-command-prefix-key' once `helm-config' is loaded.

  (global-set-key (kbd "C-c h") 'helm-command-prefix)

  (define-key helm-map (kbd "<tab>") 'helm-execute-persistent-action) ; rebind tab to run persistent action

  (define-key helm-map (kbd "C-i") 'helm-execute-persistent-action) ; make TAB work in terminal

  (define-key helm-map (kbd "C-z")  'helm-select-action) ; list actions using C-z

  (define-key helm-map (kbd "C-j") 'helm-next-line)
  (define-key helm-map (kbd "C-k") 'helm-previous-line)
  (define-key helm-map (kbd "C-h") 'helm-next-source)
  (define-key helm-map (kbd "C-S-h") 'describe-key)
  (define-key helm-map (kbd "C-l") (kbd "RET"))
  (define-key helm-map [escape] 'helm-keyboard-quit)
  (dolist (keymap (list helm-find-files-map helm-read-file-map))
    (define-key keymap (kbd "C-l") 'helm-execute-persistent-action)
    (define-key keymap (kbd "C-h") 'helm-find-files-up-one-level)
    (define-key keymap (kbd "C-S-h") 'describe-key))

  (when (executable-find "curl")
    (setq helm-google-suggest-use-curl-p t))

  (setq helm-split-window-in-side-p           t ; open helm buffer inside current window, not occupy whole other window
        helm-move-to-line-cycle-in-source     t ; move to end or beginning of source when reaching top or bottom of source.
        helm-ff-search-library-in-sexp        t ; search for library in `require' and `declare-function' sexp.
        helm-scroll-amount                    8 ; scroll 8 lines other window using M-<next>/M-<prior>
        helm-ff-file-name-history-use-recentf t
        helm-echo-input-in-header-line t)

  (setq helm-autoresize-max-height 0)

  (setq helm-autoresize-min-height 40)

  ;; fix helm error
  ;; (defun evil//hide-cursor-in-helm-buffer()
  ;;   "hide the cursor in helm buffer"
  ;;   (with-helm-buffer
  ;;     (setq cursor-in-non-selected-windows nil)))

  ;; (add-hook 'helm-after-initialize-hook
  ;;        'evil//hide-cursor-in-helm-buffer)

  (helm-autoresize-mode 1)
  )
#+end_src
*** web-mode
#+begin_src emacs-lisp
(require 'web-mode)

;; support html and more web type language
(add-to-list 'auto-mode-alist '("\\.html?\\'" . web-mode))
(add-to-list 'auto-mode-alist '("\\.css?\\'" . web-mode))
(add-to-list 'auto-mode-alist '("\\.js?\\'" . web-mode))
(add-to-list 'auto-mode-alist '("\\.xml?\\'" . web-mode))
(add-to-list 'auto-mode-alist '("\\.jsx?\\'" . web-mode))
(add-to-list 'auto-mode-alist '("\\.scss?\\'" . web-mode))

;; customize
(defun my-web-mode-hook()
  "Hooks for web mode"
  (setq web-mode-markup-indent-offset 2)  ;; html element offset identation
  (setq web-mode-css-at-rules 2) ;; css element offset identation
  (setq web-mode-code-indent-offset 2) ;; script/code offset indentation
  ;; other code script offset identation

  )

(add-hook 'web-mode 'my-web-mode-hook)

;; Add svelte mode
(add-to-list 'load-path "~/.emacs.d/lisp/utils/web/sveltejs/")
(require 'svelte-mode)
(customize-set-variable 'svelte-basic-offset 2)
(add-to-list 'auto-mode-alist '("\\.html?\\'" . svelte-mode))
(add-to-list 'auto-mode-alist '("\\.html?\\'" . svelte-mode))

;; Add Html folder
                                        ;(add-to-list 'load-path "~/.emacs.d/lisp/utils/web/html/html-fold/")
                                        ;(autoload 'html-fold-mode "html-fold" "Minor mode for hiding and revealing elements." t)
                                        ;(add-hook 'html-mode-hook 'html-fold-mode)
#+end_src
*** web-beautify
#+begin_src emacs-lisp
(eval-after-load 'js2-mode
  '(add-hook 'js2-mode-hook
             (lambda ()
               (add-hook 'before-save-hook 'web-beautify-js-buffer t t))))

(eval-after-load 'js-mode
  '(add-hook 'js2-mode-hook
             (lambda ()
               (add-hook 'before-save-hook 'web-beautify-js-buffer t t))))

(eval-after-load 'json-mode
  '(add-hook 'js2-mode-hook
             (lambda ()
               (add-hook 'before-save-hook 'web-beautify-js-buffer t t))))

(eval-after-load 'web-mode
  '(add-hook 'js2-mode-hook
             (lambda ()
               (add-hook 'before-save-hook 'web-beautify-js-buffer t t))))

(eval-after-load 'css-mode
  '(add-hook 'js2-mode-hook
             (lambda ()
               (add-hook 'before-save-hook 'web-beautify-js-buffer t t))))
#+end_src
t
*** company
#+begin_src emacs-lisp
(require 'company)
(require 'company-go)
;; use company-mode in all buffers
(add-hook 'after-init-hook 'global-company-mode)

;; configure java script
;; (add-to-list 'load-path "~/.emacs.d/lisp/utils/company/company-tern/company-tern.el")
;;(add-hook 'js-mode-hook
;;		  (lambda()
;;			(setq company-backends '(company-tern))))

;; (add-hook 'js-mode-hook
;;                '(lambda ()
;;                       (setq-local company-backends '((company-web company-css company-tern :with company-yasnippet)))))


;; (add-to-list 'company-backends 'company-tern)
(setq company-tern-meta-as-single-line t)
(setq company-tooltip-align-annotations t)


;;; company web mode configuration

;; load HTML|jade|slim backend
(require 'company-web-html)
(require 'company-web-jade)
(require 'company-web-slim)
(define-key web-mode-map (kbd "TAB") 'company-web-html)

;; (setq company-minimum-prefix-length 0) ; WARNING, probably you will get perfomance issue if min len is 0!
(setq company-tooltip-limit 20)                      ; bigger popup window
(setq company-tooltip-align-annotations 't)          ; align annotations to the right tooltip border
(setq company-idle-delay .3)                         ; decrease delay before autocompletion popup shows
(setq company-echo-delay 0)							 ; remove annoying blinking
(setq company-begin-commands '(self-insert-command)) ; start autocompletion only after typing
;; (global-set-key (kbd "C-c /") 'company-files)        ; Force complete file names on "C-c /" key

;; Only use company-mode with company-web-html in web-mode
(add-hook 'web-mode-hook
          (lambda ()
            (set (make-local-variable 'company-backends)'(company-web-html))))

;;; shell mode configuration with company mode

;; make URL clickable
(add-hook 'shell-mode-hook (lambda () (goto-address-mode)))
;; make file path clickable
(add-hook 'shell-mode-hook 'compilation-shell-minor-mode)
;; active shell mode
(add-hook 'shell-mode-hook #'company-mode)
(define-key shell-mode-map (kbd "TAB") #'company-manual-begin)
#+end_src
*** rainbow delimiters
#+begin_src emacs-lisp
(add-hook 'prog-mode-hook #'rainbow-delimiters-mode)
#+end_src
*** yasnippet
#+begin_src emacs-lisp
(require 'yasnippet)
;; (setq yas-snippet-dirs
;;              '(
;;                "~/.emacs.d/snippets/"		;personal snippers.
;;                "~/.emacs.d/elpa/yasnippet-snippets-20200802.1658/snippets/" ;extra package collection.
;;                )
;;              )

;; global enable `aggressive-indent-mode'
;; (global-aggressive-indent-mode 1)

(yas-minor-mode 1)
(add-hook 'prog-mode-hook #'yas-minor-mode)
(yas-global-mode 1)

(yas-reload-all)
(require 'yasnippet-snippets)
;; 将html mode 排除在外
;; (add-to-list 'aggressive-indent-excluded-modes 'html-mode)

;; 在ORG MODE里面 yas-expand 巨恶心，只能取消下。
;; https://joaotavora.github.io/yasnippet/snippet-expansion.html#org87a6f68
;; (define-key yas-minor-mode-map (kbd "<tab>") nil)
(define-key yas-minor-mode-map [(tab)] nil)
(define-key yas-minor-mode-map (kbd "TAB") nil)

(define-key org-mode-map (kbd "<backtab>") nil)

(defun revolt/company-to-yasnippet ()
  (interactive)
  (company-abort)
  (call-interactively 'company-yasnippet))

(bind-key "<backtab>" 'revolt/company-to-yasnippet company-active-map)
(bind-key "<backtab>" 'company-yasnippet)

;; Bind `SPC' to `yas-expand' when snippet expansion available (it
;; will still call `self-insert-command' otherwise).
;;(define-key yas-minor-mode-map (kbd "SPC") yas-maybe-expand)
;; Bind `C-c y' to `yas-expand' ONLY.

;;(define-key yas-minor-mode-map (kbd "C-c y") #'yas-expand)
#+end_src

*** flyspell
#+begin_src emacs-lisp
;; hunspell dict in here download: https://extensions.libreoffice.org/en/extensions/show/english-dictionaries
;; https://tex.stackexchange.com/questions/313370/installing-a-dictionary-files-extension-oxt
;; uzip oxt file is OK .

;; Plain text mode
(dolist (hook '(text-mode-hook org-mode-hook))
  (add-hook hook (lambda () (flyspell-mode 1))))

;; log mode
(dolist (hook '(change-log-mode-hook log-edit-mode-hook))
  (add-hook hook (lambda () (flyspell-mode -1))))

;; code comment scene
(add-hook 'emacs-lisp-mode-hook
          (lambda ()
            (flyspell-prog-mode)
            ))

;; use hunspell
(setq ispell-program-name (executable-find "hunspell")
      ispell-dictionary "en_US")

;; key binding `helm-flyspell-correct' auto fix word error
(define-key org-mode-map (kbd "C-'") nil)

;; set helm flysepll dictionary
(define-key flyspell-mode-map (kbd "C-'") 'helm-flyspell-correct)

;;; TODO: how to removing words form the hunspell directory

;;; how to running flyspell on any type of buffer?
;; =M-x flyspell-buffer=
#+end_src
*** circe
#+begin_src emacs-lisp
(require 'circe)
(setq circe-network-options
      '(("Freenode"
         :tls t
         :nick "revolt"
         :sasl-username "mrrevolt"
         :sasl-password "pz621z521wodejia"
         :channels ("#emacs")
         )))
#+end_src
*** real-save-mode
#+begin_src emacs-lisp
(with-eval-after-load 'real-auto-save
  (require 'real-auto-save)
  (add-hook 'org-mode-hook 'real-auto-save-mode)
  (add-hook 'markdown-mode-hook 'real-auto-save-mode)
  (add-hook 'shell-mode-hook 'real-auto-save-mode)

  (setq real-auto-save-mode t)
  (setq real-auto-save-interval 1.2)	; Auto save interval is 2 secodes

  ;; (setq real-auto-save-use-idle-timer 2)
  )
#+end_src
*** pdf tools
#+begin_src emacs-lisp
(pdf-tools-install)
(defun my/org-ref-open-pdf-at-point ()
  "Open the pdf for bibtex key under point if it exists."
  (interactive)
  (let* ((results (org-ref-get-bibtex-key-and-file))
         (key (car results))
         (pdf-file (car (bibtex-completion-find-pdf key))))
    (if (file-exists-p pdf-file)
        (funcall bibtex-completion-pdf-open-function pdf-file)
      (message "No PDF found for %s" key))))
#+end_src
*** emmet && mode indent
#+begin_src emacs-lisp
(require 'emmet-mode)

;; you should know how to use html abbreviations and css abbreviations
;; https://github.com/smihica/emmet#html
;; https://github.com/smihica/emmet#css

(add-hook 'html-mode-hook 'emmet-mode)
(add-hook 'css-mode-hook 'emmet-mode)
(add-hook 'web-mode-hook 'emmet-mode)

;; set indent 2 space.
(add-hook 'emmet-mode-hook (lambda () (setq emmet-indentation 2)))
(setq emmet-move-cursor-between-quotes t)

;; unset C-<return> key, rebind to PYIM input method pinyin convert
(define-key emmet-mode-keymap (kbd "C-<return>") nil)
;; (global-set-key (kbd "C-<return>") 'pyim-convert-code-at-point)

(define-key emmet-mode-keymap (kbd "C-j") 'emmet-expand-line)
;; (global-set-key (kbd "<tab>") 'emmet-expand-line)
#+end_src
*** COMMENT js tern mode
#+begin_src emacs-lisp
(with-eval-after-load 'tern

  ;; fix bug: The current directory can not be found "tern"
  ;; ref link: https://github.com/syl20bnr/spacemacs/issues/5993
  ;; (setenv "PATH" (concat (getenv "PATH") ":/usr/bin/"))
  ;; (setq exec-path (append exec-path '("/usr/bin/")))

  (autoload 'tern-mode "tern.el" nil t)

  ;; if you want to enable auto-complete mode in specific mode
  (add-to-list 'ac-modes 'svelte-mode)
  (add-to-list 'ac-modes 'js-mode)

  (add-hook 'js-mode-hook (lambda () (tern-mode t)))
  (add-hook 'web-mode-hook (lambda () (tern-mode t)))
  (add-hook 'svelte-mode-hook (lambda () (tern-mode t)))

  ;; Auto-Complete
  (eval-after-load 'tern
    '(progn
       (require 'tern-auto-complete)
       (tern-ac-setup)))
  ;; (set-face-attribute 'ac-candidate-face ((t (:inherit popup-face :background "cornsilk" :foreground "dim gray" :weight normal :family "Fira Code"))))

  (set-face-attribute 'ac-candidate-face nil   :background "khaki" :foreground "dim gray" :family "Fira Code")
  (set-face-attribute 'ac-selection-face nil   :background "SteelBlue4" :foreground "white"  :family "Fira Code")
  (set-face-attribute 'popup-tip-face    nil   :background "wheat" :foreground "slate blue"  :family "Fira Code")

  ;; '(ac-gtags-selection-face ((t (:inherit ac-selection-face :background "medium purple"))))

  ;; real JavaScript project tern configure tutorial link: https://medium.com/@jrwillette88/tern-why-it-breaks-and-how-to-fix-it-8d1677df05f9
  )
#+end_src
*** neotree
#+begin_src emacs-lisp
(require 'neotree)
(setq neo-theme (if (display-graphic-p) 'icons 'arrow))
#+end_src
*** posframe
#+begin_src emacs-lisp
(require 'posframe)
#+end_src
*** all-the-icon
#+begin_src emacs-lisp
(require 'all-the-icons)
#+end_src
*** COMMENT sdcv
#+begin_src emacs-lisp
;; ref link: https://emacs-china.org/t/emacs/7750

(require 'sdcv)

(setq sdcv-say-word-p t)

(setq sdcv-dictionary-data-dir "~/.stardict/dic/")

(setq sdcv-dictionary-simple-list
      ;;setup dictionary list for simple search
      '("懒虫简明英汉词典"
        "懒虫简明汉英词典"
        ;;"KDic11万英汉词典"
        ))

(setq sdcv-dictionary-complete-list
      '(
        "朗道汉英字典5.0"
        "新世纪汉英科技大词典"
        "懒虫简明汉英词典"
        "21世纪英汉汉英双向词典"
        "XDICT英汉辞典"
        "21世纪英汉汉英双向词典"
        "懒虫简明英汉词典"
        "新世纪英汉科技大词典"
        "XDICT汉英辞典"
        "计算机词汇"
        "英汉汉英专业词典"
        "KDic11万英汉词典"
        ))
#+end_src
*** engine
#+begin_src emacs-lisp
(require 'engine-mode)
(engine-mode t)

;; change your defalut browser
(setq engine/browser-function 'eww-browse-url)

(defengine github
  "https://github.com/search?ref=simplesearch&q=%s")

(defengine duckduckgo
  "https://duckduckgo.com/?q=%"
  :keybinding "d"
  :browser 'eww-browse-url)

(defengine google
  "https://google.com/?q=%"
  :keybinding "g")
#+end_src
*** COMMENT Company english helper
#+begin_src emacs-lisp
(add-to-list 'load-path (expand-file-name "~/.emacs.d/.utils/company-english-helper"))
;; I bind =SPC c e= command
(require 'company-english-helper)
#+end_src
*** COMMENT Insert translate name
#+begin_src emacs-lisp
(add-to-list 'load-path (expand-file-name "~/.emacs.d/.utils/insert-translated-name.el"))
(require 'insert-translated-name)
#+end_src
*** expand region
#+begin_src emacs-lisp
(setq alphabet-start "abc def")
(require 'expand-region)
(global-set-key (kbd "C-=") 'er/expand-region)
#+end_src
*** pyim
#+begin_src emacs-lisp
(require 'pyim)
;; (require 'pyim-basedict)
;; (pyim-basedict-enable)

;; load great dict
;; ref link: https://github.com/tumashu/pyim-greatdict
(add-to-list 'load-path  "~/.emacs.d/.utils/dict/pyim-greatdict/")

;; use big dict
(require 'pyim-greatdict)
(pyim-greatdict-enable)

(setq default-input-method "pyim")
(setq pyim-page-tooltip 'posframe)
(setq pyim-page-length 5)

;; 双拼模式
(setq pyim-default-scheme 'quanpin)

;; enable pinyin search function
;; (pyim-isearch-mode 1)

;; (global-set-key (kbd "SPC-SPC") 'toggle-input-method)

;; 直接使用半角符号。
;; Optinals parameters: yes/no/auto
(setq pyim-punctuation-translate-p 'no)

;; 中英文切换
(setq-default pyim-english-input-switch-functions
              '(pyim-probe-dynamic-english
                pyim-probe-isearch-mode
                pyim-probe-program-mode
                pyim-probe-org-structure-template))

(setq-default pyim-punctuation-half-width-functions
              '(pyim-probe-punctuation-line-beginning
                pyim-probe-punctuation-after-punctuation))

;; https://emacs.stackexchange.com/questions/1020/problems-with-keybindings-when-using-terminal
;; So sorry, I want to bind `<M-<return>' give 'pyim-convert-code-at-point,but not working in xterm.
;; you know, xterm M-RET is fullscreen, i already ban it,but still not working.So i guess remove xterm M-RET key bind.
(define-key org-mode-map (kbd "C-<return>") nil)
(global-set-key (kbd "C-<return>") 'pyim-convert-code-at-point)

;; enable guess word

;; import outside pyim dict
;; (setq pyim-dicts
;;       '(
;;      (:name "dict1" :file "~/.emacs.d/dict/scel2pyim/pyim-dict/pyim-bigdict.pyim")
;;      (:name "dict2" :file "~/.emacs.d/dict/scel2pyim/pyim-dict/computer_all_word.pyim")
;;      (:name "dict3" :file "~/.emacs.d/dict/scel2pyim/pyim-dict/programming.pyim")
;;      ))

;; When you start emacs auto load thesaurus
(add-hook 'emacs-startup-hook
          #'(lambda() (pyim-restart-1 t)))
#+end_src
*** command-log
#+begin_src emacs-lisp
(with-eval-after-load
    (require 'command-log-mode)
  ;; (add-hook 'emacs-startup-hook 'command-log-mode-hook)

  (defun enable-command-log()
    (interactive)
    (command-log-mode 1)
    (clm/toggle-command-log-buffer))
  (global-set-key (kbd "C-c o") 'enable-command-log)
  )
#+end_src
*** better-default
#+begin_src emacs-lisp
(require 'better-defaults)
#+end_src
*** projectile
#+begin_src emacs-lisp
(projectile-mode +1)
(define-key projectile-mode-map (kbd "C-c p") 'projectile-command-map)
#+end_src
*** mode line
#+begin_src emacs-lisp
(require 'doom-modeline)
(require 'all-the-icons)
(setq doom-modeline-minor-modes t)
(setq doom-modeline-indent-info t)
(setq inhibit-compacting-font-caches t)
(doom-modeline-mode 1)
#+end_src
*** ox-hugo
#+begin_src emacs-lisp
(with-eval-after-load 'ox
  (require 'ox-hugo))
#+end_src
*** golden ration window
#+begin_src emacs-lisp
;; -*-Emacs-lisp-*-
(require 'golden-ratio)
(golden-ratio-mode 1)
(require 'ace-window)
#+end_src
*** COMMENT golang
#+begin_src emacs-lisp
(require 'go-mode)
(autoload 'go-mode "go-mode" nil t)
(add-to-list 'auto-mode-alist '("\\.go\\'" . go-mode))

(defun my-go-hook ()
  (when buffer-file-name
    (setq-local company-backends '(company-go))))

(add-hook 'go-mode-hook #'my-go-hook)

;; format go code
(add-hook 'before-save-hook 'gofmt-before-save)

;; go-remove-unused-imports
(add-hook 'go-mode-hook (lambda ()
                          (local-set-key (kbd "C-c C-r") 'go-remove-unused-imports)))


;;; Go Mode Usage
;; 1.go-import-add
;; 2.go-remove-unused-imports

;;; Navigating Code
;; 1.beginning-of-defun
;; 2.end-of-defun

;; Go Code integrates with godef, godef is able to parse your code,
;; and the code of other packages,and the code of the Go standard
;; library, and can tell you what exactly the symbol you're looking at
;; means and where it has been defined.

;; go-mode provide two functions:
;; 1.godef-describe --- tell you what you're looking at.
;; 2.godef-jump --- jump will take you to its definition.
;; 3.go-goto-imports
(add-hook 'go-mode-hook (lambda ()
                          (local-set-key (kbd "C-c i") 'go-goto-imports)))

(add-hook 'go-mode-hook (lambda ()
                          (local-set-key (kbd "C-c j") 'godef-jump)))
;;                           (local-set-key (kbd \"M-.\") 'godef-jump)))
#+end_src
*** COMMENT lsp mode
#+begin_src emacs-lisp
;; Set prefix for lsp-mode keybindings.
(setq lsp-keymap-prefix "s-l")
(require 'lsp-mode)
(add-hook 'go-mode-hook #'lsp)

(require 'company-lsp)
(push 'company-lsp company-backends)

(setq lsp-gopls-staticcheck t)
(setq lsp-eldoc-render-all t)
(setq lsp-gopls-complete-unimported t)

;; gopls (go please) 是Go 语言的官方语言服务器。
;; LSP(语言服务器协议的缩写),使用 lsp-mode, gopls 作为客户端被构建。首
;; 先你必须安装 gopls, 并把它放置到你的 PATH 路径下。

;; ref link: https://github.com/golang/tools/blob/master/gopls/doc/emacs.md
;; install gopls, run command: GO111MODULE=on go get golang.org/x/tools/gopls@latest

(setf (lsp-session-folders-blacklist (lsp-session)) nil)
(lsp--persist-session (lsp-session))

;; ref link: https://gitter.im/emacs-lsp/lsp-mode?at=5e01b105c62fdf33f744a629
;; (setq lsp-auto-guess-root t)

(let ((project-root-suggestion (or (lsp--suggest-project-root) default-directory)))
  (read-key (format
             "%s is not part of any project. Select action:

%s==>Import project root %s.
%s==>Import project by selecting root directory interactively.
%s==>Do not ask again for the current project by adding %s to lsp-session-folder-blacklist.
%s==>Do not ask again for the current project by selecting ignore path interactively.
%s==>Do nothing: ask again when opening other files from the current project."
             (propertize (buffer-name) 'face 'bold)
             (propertize "i" 'face 'success)
             (propertize project-root-suggestion 'face 'bold)
             (propertize "I" 'face 'success)
             (propertize "d" 'face 'warning)
             (propertize project-root-suggestion 'face 'bold)
             (propertize "D" 'face 'warning)
             (propertize "n" 'face 'warning)))
  )
(lsp-register-custom-settings
 '(("gopls.completeUnimported" t t)
   ("gopls.staticcheck" t t)))


;;; Eslint Support

(setq lsp-eslint-server-command
      '("node"
        "/home/revolt/.nvm/versions/node/v12.8.1/lib/node_modules/eslint/lib/eslint/eslint.js"
        "--stdio"))
#+end_src
*** flycheck
#+begin_src emacs-lisp
(with-eval-after-load 'flycheck
  (require 'flycheck)
  (add-hook 'sh-mode-hook 'flycheck-mode)
  )
#+end_src
*** yaml
#+begin_src emacs-lisp
(require 'yaml-mode)
(add-to-list 'auto-mode-alist '("\\.yml\\'" . yaml-mode))
(defun org-babel-execute:yaml (body params) body)
#+end_src
*** google translate
#+begin_src emacs-lisp
;; Emacs google translate
;; ref link
;; https://github.com/atykhonov/google-translate

;;; Code:
(require 'google-translate)
(require 'google-translate-smooth-ui)
(global-set-key "\C-ct" 'google-translate-smooth-translate)

;; (with-eval-after-load 'google-translate
;;   (require 'google-translate)
;;   (require 'google-translate-default-ui)
;;   (global-set-key "\C-ct" 'google-translate-at-point)
;;   (global-set-key "\C-cT" 'google-translate-query-translate)
;;   )

;; fix ttk error
(defun google-translate--search-tkk ()
  "Get the Token-Key from the page buffer."
  (let (downloaded)
    (setq downloaded (shell-command-to-string "curl -s --user-agent 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_2) AppleWebKit/600.3.18 (KHTML, like Gecko) Version/8.0.3 Safari/600.3.18' 'https://translate.google.com' | sed 's/,/\\n,/g' | grep ',tkk'"))
    (print downloaded)
    (with-temp-buffer (insert downloaded)
                      (goto-char 0)
                      (re-search-forward ",tkk:'\\([0-9]+\\)\\.\\([0-9]+\\)")
                      (list (string-to-number (match-string 1))
                            (string-to-number (match-string 2))))))
#+end_src
*** COMMENT Keyfreq

#+begin_src emacs-lisp
(require 'keyfreq)
(keyfreq-mode 1)
(keyfreq-autosave-mode 1)
#+end_src
*** Emojify
#+begin_src emacs-lisp
(add-hook 'after-init-hook #'global-emojify-mode)
#+end_src
*
*** Undo-tree
#+begin_src emacs-lisp
(global-undo-tree-mode)
#+end_src
*** highlight-symbol
#+begin_src emacs-lisp
(require 'highlight-symbol)
(global-set-key [(control f3)] 'highlight-symbol)
(global-set-key [f3] 'highlight-symbol-next)
(global-set-key [(shift f3)] 'highlight-symbol-prev)
(global-set-key [(meta f3)] 'highlight-symbol-query-replace)
#+end_src
*** Vterm
#+begin_src emacs-lisp
(require 'vterm)
#+end_src


** Linux

*** zsh

*** GnuPG

*** ssh


** Emacs lisp 杀戮场
:PROPERTIES:
:header-args: :tangle no
:END:


*** 函数

#+name: define_function
#+begin_src emacs-lisp
;; ref link: http://xahlee.info/comp/lisp_read-from-minibuffer_propels_deep_questions.html
(defun shell-command-on-buffer ()
  "Asks for a command and executes it in inferior shell with current bufferas input."
  (interactive)
  (shell-command-on-region
   (point-min)
   (point-max)
   (read-shell-command
    (format "Run you slected shell command: (default file is %s) "(buffer-name))(buffer-name))))
;; insert (format "%S" (buffer-name))
#+end_src

*** 键盘宏 和 alias

#+name: define keyboard_macro and set alias
#+begin_src emacs-lisp
;; customize keyboard macro
(fset 'helloa
      (kmacro-lambda-form [?\( ?m ?e ?s ?s ?a ?g ?e ?  ?\" ?h ?e ?l ?l ?o ?\" ?\)] 0 "%d"))

;; my-command-line macro
(fset 'my-comment-line
      (kmacro-lambda-form [?» ?\C-u ?5 ?0 ?-] 0 "%d"))

;; convenient
(defalias 'rs 'replace-string)
#+end_src

*** Org mode Capture Template
:PROPERTIES:
:header-args: :tangle yes
:END:

**** 设置测试环境
下面测试下它的相关参数：

| Content | Description                              |
|---------+------------------------------------------|
| %a      | 已替换为指向从中调用捕获命令的位置的链接 |

#+begin_src emacs-lisp :tangle "~/.emacs.d/.test/test.el"
;; no startup msg
(setq inhibit-startup-message t)

(setq org-dir "~/.emacs.d/.org/")

;; set suitable scene
(interactive)
(find-file org-dir)

(defun revolt/org-goto-last-tasks-headline ()
  "Move point to the last headline in file matching \"**** Tasks\"."
  (goto-char (point-max))
  ;; (re-search-backward "^\\*\\*\\*\\* Tasks"))
  (re-search-backward "^\\* Test file\\+\\function"))

(defun my/expense-template ()
  (format "Hello world %s" (plist-get org-capture-plist :account)))

(setq org-capture-templates
      `(
        ("f" "捕捉参考文献" entry (file+headline "~/.emacs.d/.org/now-fight.org" "捕捉参考文献")
         "* TODO %?\n  %i\n  %a * %?\nEntered on %U\n  %i\n  %a")

        ;; ("t" "Todo" entry (file ,(concat (file-name-as-directory org-dir) "test-file.org"))
        ;;  "* TODO %?\n%U" :empty-lines 1)

        ;; ("x"  "local notes" entry
        ;;  (file+headline (lambda () (concat (file-name-as-directory org-dir) "test-file.org")) "Copied regions")
        ;;  "* %^{Title} %U \n %i")
        ("x"  "local notes" entry
         (file+headline  ,(concat (file-name-as-directory org-dir) "test-file.org") "Copied regions")
         "* %^{Title} %U \n %i")

        ;; ("e" "测试file" entry (file (concat org-dir "test-file.org")))

        ;; https://www.reddit.com/r/orgmode/comments/eln9kb/capture_with_automatic_id_creation/
        ("i" "测试id" entry (id "8fc4a985-1080-4787-a608-173987cfd820"))

        ("h" "测试 file+headline" entry (file+headline "~/.emacs.d/.org/test-file.org" "Test file+headline"))

        ;; 如果你的目标位置是3级标题之下，需要提前预设好 1级标题＋2级标题＋3级标题，
        ("o" "测试 file+olp" entry (file+olp "~/.emacs.d/.org/test-file.org" "Test file+olp" "Level 2" "Level 3"))

        ("n" "测试 file+olp+datetree" entry (file+olp+datetree "~/.emacs.d/.org/test-file.org" "Test file+olp+datetree"))

        ;; ref link: https://emacs.stackexchange.com/questions/51913/capture-todos-to-the-last-tasks-heading/51946
        ("u" "测试 file+function" entry (file+function  "~/.emacs.d/.org/test-file.org" revolt/org-goto-last-tasks-headline))

        ;; TODO clock
        ("c" "测试收集资料的时间" entry (file+headline "~/.emacs.d/.org/test-file.org" "Collection information")
         "* TODO %?\n %i" :clock-in t :clock-resume t)

        ;; ref link: https://stackoverflow.com/questions/56274067/how-to-use-the-function-option-of-org-capture-correctly
        ("p" "测试 function" entry
         (function
          (lambda ()
            ;; (interactive)
            ;; (find-file "~/.emacs.d/.org/test-file.org")
            (set-buffer (org-capture-target-buffer "~/.emacs.d/.org/test-file.org"))
            (goto-char (point-max))
            (re-search-backward "^\\* Test function")
            ))
         "* Level 2"
         :immediate-finish t            ;直接写入文件不多BB
         )

        ("y" "Test entry 2" plain
         (file "~/tmp/test.txt")
         (function my/expense-template)
         :account "Account:AnotherBank")
        ))
(interactive)
(org-capture)
#+end_src

**** Template elements

完整的 template entry 需要啥？

下面是模版定义的元素。在 =org-capture-templates= 种的每个 Entry 都是包含
以下项的 list：

- Keys ::
  选择模板的关键字，只不过是个字符串。例如： src_emacs-lisp[:exports
  code]{("f" "捕捉参考文献")} ,此中的 ="f"= 就是 keys.

- description ::
  描述模版的简要描述

- type ::
  entry 的类型，类型为 =symblo=.
  - entry
    带 headline 的 Org mode 节点。将作为目标 Entry 的 Subentry 或者
    top Entry 来进行归档。目标文件应该是 Org mode file.
  - item
    纯 list item,放置在目标位置的首个纯list.该目标文件应该是 Org mode file.
  - checkitem
    checkbox item. 仅与默认模板中的普通列表项不同。
  - table-line
    在目标位置的第一个表中新建一行。行插入的确切位置取决于属性
    =:prepend= 和 =:table-line-pos=.
  - plain
    作为纯文本插入。

- target ::
  指定捕获的 item 应该放置的位置。在 Org mode 中，Entries 将会成为这个
  节点的子节点。其他类型将添加到此节点主体中的表或列表中。大多数目标指
  定包含文件名。 *如果文件名是空字符串，它默认是
  org-default-notes-file*. 文件也可以作为变量或者没有参数调用的函数给定，
  如果没有为目标指定绝对路径，则将其视为 =org-directory=.

  有效的值有：
  - ‘(file "path/to/file")’
    文本将放在该文件的开头或结尾。测试结果：[[file:.org/test-file.org::*test file again][test file again]]

  - ‘(id "id of existing org entry")’
    作为该条目的子条目或在该条目的正文中归档。测试结果：[[file:.org/test-file.org::*Test Entry with ID][Test Entry with ID]]

  - ‘(file+headline "filename" "node headline")’
    如果目标标题在文件中是唯一的，则快速配置。测试结果：[[file:.org/test-file.org::*Test file+headline][Test file+headline]]

  - ‘(file+olp "filename" "Level 1 heading" "Level 2" ...)’
    对于非唯一标题，完整路径更安全。测试结果：[[file:.org/test-file.org::*Test file+olp][Test file+olp]]

  - ‘(file+regexp "filename" "regexp to find location")’
    使用正则表达式定位位置

  - ‘(file+olp+datetree "filename" [ "Level 1 heading" ...])’
    此目标[fn:1]在 date tree 中为今天创建 heading,如果如果给定了可选的轮廓路
    径，树将在它所指向的节点下构建，而不是在顶层构建。查看下面
    的:time-prompt和:tree-type属性以获得其他选项。测试结果：[[file:.org/test-file.org::*This is file olp datetree test][This is file olp datetree test]]

  - ‘(file+function "filename" function-finding-location)’
    在文件中找到正确位置的函数。测试结果：[[file:.org/test-file.org::*This is a test][This is a test]]

  - ‘(clock)’

  - '(function function-finding-location)'
    最常见的方法:编写自己的函数，既访问文件，又移动指向正确的位置。 测
    试结果：[[file:.org/test-file.org::*Level 2][Level 2]]

*** Defining variables
#+begin_src emacs-lisp
;;; Constants
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

ELISP> (defconst zsh-shell "/usr/bin/zsh")
zsh-shell

ELISP> zsh-shell
"/usr/bin/zsh"
ELISP>

;;; Define a variable
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;;;; Set is not used very much
;;
ELISP> (set 'avar "hello world")
"hello world"

ELISP> avar
"hello world"
ELISP>

;;;;; The most used command for assignment is setq
;;
ELISP> (setq x 10)
10

ELISP> (setq avar "hello world")
"hello world"

ELISP> x
10

ELISP> avar
"hello world"
ELISP>

ELISP> (setq my-list '(10 20 30 40))
(10 20 30 40)

ELISP> my-list
(10 20 30 40)

;;; Multiple Assignment
;;
ELISP> (setq a 10 b 20 c "Emacs")
"Emacs"
ELISP> a
10
ELISP> b
20
ELISP> c
"Emacs"
ELISP>

;; Dynamic Scoping  (Local Variables)
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;
ELISP> (let ((x 1) (y 10)) (+ (* 4 x) (* 5 y)) )
54
ELISP> x
10
ELISP> y
,** Eval error **  Symbol's value as variable is void: y
ELISP>
#+end_src

#+begin_src emacs-lisp
(let* ((org-dir "~/.emacs.d/.org/"))
  (concat org-dir "a.org"))
#+end_src

#+RESULTS:
: ~/.emacs.d/.org/a.org

*** Lambda Expressions
#+begin_src emacs-lisp :results raw
(lambda (x)
  "return the hyperbolic cosine of x."
  (* 0.5 (+ (exp x) (exp (- x))))
 )
#+end_src

*** concat
#+begin_src emacs-lisp
(concat (file-name-directory buffer-file-name) "notes.org")
#+end_src

#+RESULTS:
: /home/mrrevolt/.emacs.d/notes.org


* Footnotes

[fn:1] Org 曾经为 date/week tree 捕获提供来四个不同的目标。现在，Org自
动使用 =file+olp+datetree= 将这些转换，应用 =:time-prompt= 和 =:tree-type=
属性。请使用file+olp+datetree重写你的 date/week 目标，因为旧的目标现在已
经过时了。
